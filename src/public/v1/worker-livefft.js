var loop,audioData=[0,0,0,0],lowAudioData=[0,0,0,0],maxFreq=22050,lowFreq=6e3,lowFreqIndex=0,maxDecibel=-30,minDecibel=-100,decibelRange=70,volumeNormalizer=30,canvas=[],pause=!0,forcount=0,normalizedFreqArray=[0,0,0,0],normalizedFreqArray2=[0,0,0,0],normalizedFreqObject={0:0};onmessage=event=>{const data=event.data.data;switch(event.data.event){case"audioData":{audioData=data.audioData,lowAudioData=data.lowAudioData;break}case"play":{pause=!1,requestAnimationFrame(animationFrame);break}case"pause":{pause=!0;break}case"init":{maxFreq=data.maxFreq,lowFreq=data.lowFreq,maxDecibel=data.maxDecibel,minDecibel=data.minDecibel,volumeNormalizer=data.volumeNormalizer,decibelRange=maxDecibel-minDecibel;break}case"addCanvas":{var id=data.id,c={};c.type=data.type,c.element=data.element,c.res=data.res,c.element.width=data.offsetWidth*c.res,c.element.height=data.offsetHeight*c.res,c.context=c.element.getContext("2d"),canvas.push([id,c]),oneFrameCanvas(),frame();break}case"resizeCanvas":{for(var id=data.id,index=null,i=0;i<canvas.length;i++)if(canvas[i][0]==id){var c=canvas[i][1];c.element.width=data.offsetWidth*c.res,c.element.height=data.offsetHeight*c.res;break}oneFrameCanvas(),frame();break}case"removeCanvas":{for(var id=data.id,index=null,i=0;i<canvas.length;i++)if(canvas[i][0]==id){index=i;break}index&&canvas.splice(index,1);break}case"frame":{frame();break}case"close":{pause=!0;break}}};function animationFrame(){pause||(forcount=0,frame(),requestAnimationFrame(animationFrame))}function frame(){normalizedFreqArray=getNormalizedFreqDecibelArray(1*decibelRange),normalizedFreqArray2=getNormalizedFreqDecibelArray2(1*decibelRange);for(var c of canvas)switch(c[1].type){case"freqline":{drawFreqLine(c[1]);break}case"freqbar":{drawFreqBar(c[1]);break}case"freqlogline":{drawFreqLogLine(c[1]);break}}}function oneFrameCanvas(){for(var c of canvas){var cc=c[1];switch(cc.type){case"freqloglabel":{drawFreqLogLabel(cc);break}}}}function getFreqDecibelArray(n){function pushFreq(f,db){20>f?freqArray.push([f,0]):freqArray.push([f,db])}for(var dataArray=audioData,afb=maxFreq/dataArray.length,freqArray=[],i=0;i<dataArray.length;i++)pushFreq(afb*i,dataArray[i]/255*n);return freqArray}function getFreqDecibelArray2(n){function pushFreq(f,db){20>f?freqArray.push([f,0]):freqArray.push([f,db])}var dataArray=audioData,lowDataArray=lowAudioData,afb=maxFreq/dataArray.length,lfb=lowFreq/lowDataArray.length,ais=Math.floor(lowFreq/afb);lowFreqIndex=ais;for(var freqArray=[],i=0;i<lowDataArray.length;i++)forcount++,pushFreq(lfb*i,lowDataArray[i]/255*n);for(var i=ais;i<dataArray.length;i++)forcount++,afb*i>lowFreq?pushFreq(afb*i,dataArray[i]/255*n):lowFreqIndex=i;return freqArray}function getFreqDecibel(f,a){if(0>=f||2e4<=f)return 0;if(8>a.length)return 0;for(var fs=Math.floor(a.length/a[a.length-1][0]*f),i=fs;i<fs+100;i++)if(forcount++,a[i][0]<=f&&f<=a[i+1][0]){var f1=a[i],f2=a[i+1],c1=f2[0]-f1[0],c2=f2[1]-f1[1],c3=f-f1[0],r=f1[1]+c2/c1*c3;return r}}function getFreqDecibel2(f,a){if(0>=f||maxFreq<=f||2e4<=f)return 0;if(8>a.length)return 0;var fs=0;f<=lowFreq?fs=Math.floor(lowFreqIndex/a[lowFreqIndex][0]*f):(fs=Math.floor((a.length-lowFreqIndex)/(maxFreq-lowFreq)*(f-lowFreq)),fs+=lowFreqIndex);for(var i=fs;i<fs+100;i++)if(forcount++,a[i][0]<=f&&f<=a[i+1][0]){var f1=a[i],f2=a[i+1],c1=f2[0]-f1[0],c2=f2[1]-f1[1],c3=f-f1[0],r=f1[1]+c2/c1*c3;return r}}function getNormalizedFreqDecibelArray(n){function pushFreq(f,db){20>f?freqArray.push([f,0]):(db=normalizeDecibel(f,db),freqArray.push([f,1*db]))}for(var dataArray=audioData,lowDataArray=lowAudioData,afb=maxFreq/dataArray.length,lfb=lowFreq/lowDataArray.length,ais=Math.floor(lowFreq/afb),freqArray=[],i=0;i<lowDataArray.length;i+=1)forcount++,pushFreq(lfb*i,lowDataArray[i]/255*n);lowFreqIndex=freqArray.length-1;for(var i=ais;i<dataArray.length;i+=1)forcount++,afb*i>lowFreq&&pushFreq(afb*i,dataArray[i]/255*n);return freqArray}function getNormalizedFreqDecibelArray2(n){function pushFreq(f,db){20>f?freqArray.push([f,0]):(db=normalizeDecibel2(f,db),freqArray.push([f,1*db]))}for(var dataArray=audioData,lowDataArray=lowAudioData,afb=maxFreq/dataArray.length,lfb=lowFreq/lowDataArray.length,ais=Math.floor(lowFreq/afb),freqArray=[],i=0;i<lowDataArray.length;i+=1)forcount++,pushFreq(lfb*i,lowDataArray[i]/255*n);lowFreqIndex=freqArray.length-1;for(var i=ais;i<dataArray.length;i+=1)forcount++,afb*i>lowFreq&&pushFreq(afb*i,dataArray[i]/255*n);return freqArray}class Spline{constructor(xs,ys){this.xs=xs,this.ys=ys,this.ks=this.getNaturalKs(new Float64Array(this.xs.length))}getNaturalKs(ks){const n=this.xs.length-1,A=this.zerosMat(n+1,n+2);for(let i=1;i<n;i++)A[i][i-1]=1/(this.xs[i]-this.xs[i-1]),A[i][i]=2*(1/(this.xs[i]-this.xs[i-1])+1/(this.xs[i+1]-this.xs[i])),A[i][i+1]=1/(this.xs[i+1]-this.xs[i]),A[i][n+1]=3*((this.ys[i]-this.ys[i-1])/((this.xs[i]-this.xs[i-1])*(this.xs[i]-this.xs[i-1]))+(this.ys[i+1]-this.ys[i])/((this.xs[i+1]-this.xs[i])*(this.xs[i+1]-this.xs[i])));return A[0][0]=2/(this.xs[1]-this.xs[0]),A[0][1]=1/(this.xs[1]-this.xs[0]),A[0][n+1]=3*(this.ys[1]-this.ys[0])/((this.xs[1]-this.xs[0])*(this.xs[1]-this.xs[0])),A[n][n-1]=1/(this.xs[n]-this.xs[n-1]),A[n][n]=2/(this.xs[n]-this.xs[n-1]),A[n][n+1]=3*(this.ys[n]-this.ys[n-1])/((this.xs[n]-this.xs[n-1])*(this.xs[n]-this.xs[n-1])),this.solve(A,ks)}getIndexBefore(target){let low=0,high=this.xs.length,mid=0;for(;low<high;)mid=Math.floor((low+high)/2),this.xs[mid]<target&&mid!==low?low=mid:this.xs[mid]>=target&&mid!==high?high=mid:high=low;return low+1}at(x){let i=this.getIndexBefore(x);const t=(x-this.xs[i-1])/(this.xs[i]-this.xs[i-1]),a=this.ks[i-1]*(this.xs[i]-this.xs[i-1])-(this.ys[i]-this.ys[i-1]),b=-this.ks[i]*(this.xs[i]-this.xs[i-1])+(this.ys[i]-this.ys[i-1]),q=(1-t)*this.ys[i-1]+t*this.ys[i]+t*(1-t)*(a*(1-t)+b*t);return q}solve(A,ks){const m=A.length;let h=0,k=0;for(;h<m&&k<=m;){let i_max=0,max=-Infinity;for(let i=h;i<m;i++){const v=Math.abs(A[i][k]);v>max&&(i_max=i,max=v)}if(0===A[i_max][k])k++;else{this.swapRows(A,h,i_max);for(let i=h+1;i<m;i++){const f=A[i][k]/A[h][k];A[i][k]=0;for(let j=k+1;j<=m;j++)A[i][j]-=A[h][j]*f}h++,k++}}for(let i=m-1;0<=i;i--){var v=0;A[i][i]&&(v=A[i][m]/A[i][i]),ks[i]=v;for(let j=i-1;0<=j;j--)A[j][m]-=A[j][i]*v,A[j][i]=0}return ks}zerosMat(r,c){const A=[];for(let i=0;i<r;i++)A.push(new Float64Array(c));return A}swapRows(m,k,l){let p=m[k];m[k]=m[l],m[l]=p}}class ISO226{constructor(db){this.db=db,this.tbl_f=[20,25,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1e3,1250,1600,2e3,2500,3150,4e3,5e3,6300,8e3,1e4,12500],this.tbl_alpha_f=[.532,.506,.48,.455,.432,.409,.387,.367,.349,.33,.315,.301,.288,.276,.267,.259,.253,.25,.246,.244,.243,.243,.243,.242,.242,.245,.254,.271,.301],this.tbl_L_U=[-31.6,-27.2,-23,-19.1,-15.9,-13,-10.3,-8.1,-6.2,-4.5,-3.1,-2,-1.1,-.4,0,.3,.5,0,-2.7,-4.1,-1,1.7,2.5,1.2,-2.1,-7.1,-11.2,-10.7,-3.1],this.tbl_T_f=[78.5,68.7,59.5,51.1,44,37.5,31.5,26.5,22.1,17.9,14.4,11.4,8.6,6.2,4.4,3,2.2,2.4,3.5,1.7,-1.3,-4.2,-6,-5.4,-1.5,6,12.6,13.9,12.3],this.spline=this.iso226_spl_itpl(db)}freq(f){return this.spline.at(f)}tabled_f(){return this.tbl_f.concat(2e4)}tabled_L_p(L_N){for(var L_p=[],tbf=this.tabled_B_f(L_N),i=0;i<tbf.length;i++)L_p.push(40*Math.log10(tbf[i])+94);return L_p.concat(L_p[0])}tabled_B_f(L_p){for(var B_f=[],i=0;i<this.tbl_T_f.length;i++)B_f.push(.00447*(10**(.025*L_p)-1.15)+(.4*10**((this.tbl_T_f[i]+this.tbl_L_U[i])/10-9))**this.tbl_alpha_f[i]);return B_f.concat(B_f[0])}iso226_spl_contour(L_N){if(0>L_N||90<L_N)throw new Error("Parameter L_N out of bounds [0-90].");return[this.tabled_f(),this.tabled_L_p(L_N)]}iso226_spl_itpl(L_N){var i=this.iso226_spl_contour(L_N);return new Spline(i[0],i[1])}}function normalizeDecibel2(f,db){var f1=Math.log10(f),db1=0;return 1>f1?db1=-70.55*f1+94.87:1<=f1&&1.52>f1?db1=-28.7*f1+53.22:1.52<=f1&&2>f1?db1=-11.11*f1+26.52:2<=f1&&2.28>f1?db1=4.34:2.28<=f1&&2.58>f1?db1=-21.59*f1&&f1+53.6:2.58<=f1&&3>f1?db1=46.84*f1-123.25:3<=f1&&3.14>f1?db1=-61.67*f1+202.01:3.14<=f1&&(db1=75.76*f1-229.88),db=db-db1+1*volumeNormalizer,db}function normalizeDecibel(f,db){return new ISO226(db).freq(f)+volumeNormalizer}function equalLoudnessFilter(f,db){var f1=Math.log10(f),db1=0;return 1>f1?db1=-70.55*f1+94.87:1<=f1&&1.52>f1?db1=-28.7*f1+53.22:1.52<=f1&&2>f1?db1=-11.11*f1+26.52:2<=f1&&2.28>f1?db1=4.34:2.28<=f1&&2.58>f1?db1=-21.59*f1&&f1+53.6:2.58<=f1&&3>f1?db1=46.84*f1-123.25:3<=f1&&3.14>f1?db1=-61.67*f1+202.01:3.14<=f1&&(db1=75.76*f1-229.88),db=db-db1+1*volumeNormalizer,db}function a(x){return .0020994611424*x**8-.0362952080169*x**7+.265096822271*x**6-1.0675959388964*x**5+2.5879406359649*x**4-3.8425718410657*x**3+3.4214537302841*x**2-1.9646624592248*x+1.2496293809655}function drawFreqLine(c){var canvas=c.element,context=c.context,res=c.res,dataArray=audioData;context.clearRect(0,0,canvas.width,canvas.height),context.lineWidth=res,context.strokeStyle="rgb(0, 255, 200)",context.beginPath(),context.moveTo(0,canvas.height);for(var w=canvas.width/dataArray.length,h=canvas.height/255,i=0;i<dataArray.length;i++){var d=dataArray[i],dh=Math.max(res,d*h);context.lineTo(w*i,canvas.height-dh)}context.lineTo(w*dataArray.length,canvas.height),context.stroke()}function drawFreqBar(c){var canvas=c.element,context=c.context,res=c.res,dataArray=audioData;context.clearRect(0,0,canvas.width,canvas.height);for(var w=canvas.width/dataArray.length,i=0;i<dataArray.length;i++){var d=dataArray[i],g=0,b=d;128<=d&&(g=2*(d-128),b=d/4),context.fillStyle="rgb("+d+", "+g+", "+b+")",context.fillRect(w*i,0,w+res/2,canvas.height)}}function drawFreqLogLine(c){var canvas=c.element,context=c.context,res=c.res;context.clearRect(0,0,canvas.width,canvas.height),context.lineWidth=res,context.strokeStyle="rgba(0, 255, 200, 0.5)",context.beginPath(),context.moveTo(0,canvas.height);for(var dam=-500,dax=500,dal=dax-dam+1,w=canvas.width/dal,h=canvas.height/10**(decibelRange/10),i=dam;i<=dax;i+=1){forcount++;var f=600*2**(i/100),d=getFreqDecibel2(f,normalizedFreqArray),dh=Math.max(res,10**(d/10)*h);context.lineTo(w*(i-dam),canvas.height-dh)}context.lineTo(w*dal,canvas.height),context.stroke()}function drawFreqLogLine2(c){var canvas=c.element,context=c.context,res=c.res;context.clearRect(0,0,canvas.width,canvas.height),context.lineWidth=res,context.strokeStyle="rgba(255, 0, 85, 0.5)",context.beginPath(),context.moveTo(0,canvas.height);for(var dam=-500,dax=500,dal=dax-dam+1,w=canvas.width/dal,h=canvas.height/10**(decibelRange/10),i=dam;i<=dax;i+=1){forcount++;var f=600*2**(i/100),d=getFreqDecibel2(f,normalizedFreqArray2),dh=Math.max(res,10**(d/10)*h);context.lineTo(w*(i-dam),canvas.height-dh)}context.lineTo(w*dal,canvas.height),context.stroke()}function drawFreqLogLabel(c){var canvas=c.element,context=c.context,res=c.res;context.clearRect(0,0,canvas.width,canvas.height),context.lineWidth=res,context.strokeStyle="rgb(77, 0, 128)",context.fillStyle=context.strokeStyle,context.font=12*res+"px \"DM Mono\", Consolas",context.beginPath(),context.moveTo(0,canvas.height);var dam=-500,dax=500,dal=dax-dam+1,w=canvas.width/dal,s=100;800>canvas.width&&(s=200),800<=canvas.width&&1600>canvas.width&&(s=100),1600<=canvas.width&&(s=50);for(var i=dam;i<=dax;i+=1){forcount++;var di=i-dam,f=600*2**(i/100);(0==di%s||i+1==dal)&&(context.fillText(Math.floor(f),w*di+2*res,10*res),context.moveTo(w*di,0),context.lineTo(w*di,canvas.height))}context.lineTo(w*dal,canvas.height),context.stroke()}